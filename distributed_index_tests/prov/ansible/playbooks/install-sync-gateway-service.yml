---
- hosts: sync_gateways
  remote_user: root
  sudo: true
  vars:
    writer: "false"
    sync_gateway_config_filepath:
  tasks:
  - name: set couchbase_server_primary_node variable
    set_fact:
      couchbase_server_primary_node: "{{ hostvars['cb1']['ansible_ssh_host'] }}"

  - name: stop any sync gateway services that might be running
    service: name=sync_gateway pattern=sync_gateway state=stopped
    ignore_errors: yes
  - name: force stop sync_gateway for CentOS 6
    shell: /sbin/initctl stop sync_gateway
    ignore_errors: yes
  - name: remove sync gateway user
    user: name=sync_gateway state=absent remove=yes force=yes
  - name: add sync gateway user
    user: name=sync_gateway createhome=yes
  - name: make service install script executable
    file: path=/home/centos/sync_gateway/service/sync_gateway_service_install.sh mode=a+x
  - name: copy sync gateway binary to sync_gateway home
    shell: cp /home/centos/sync_gateway/bin/sync_gateway /home/sync_gateway
  - name: change permissions of sync gateway executable
    file: path=/home/sync_gateway/sync_gateway mode=a+x
  - name: copy sync gateway config to host
    template: src={{ sync_gateway_config_filepath }} dest=/home/sync_gateway/sync_gateway.json owner=sync_gateway group=sync_gateway mode=0644 force=true
  - name: install sync gateway service
    shell: ./sync_gateway_service_install.sh --sgpath=/home/sync_gateway/sync_gateway chdir=/home/centos/sync_gateway/service
 # - name: update service file to enable garbage collector debugging
 #   shell: sed -i '/\[Service\]/a Environment="GODEBUG=gctrace=1"' /usr/lib/systemd/system/sync_gateway.service
 # - name: reload systemctl daemon to pick up file changes
 #   shell: systemctl daemon-reload
 # - name: restart sync gateway service after service file change
 #   service: name=sync_gateway state=restarted
  - name: wait until sync gateway to listen on port
    wait_for: port=4985 delay=1 timeout=30
